{% extends "../../project_toolbox_main/templates/base.html" %}

{% load workflow_templatetags %}

{% load url from future %}
{% load bootstrap_toolkit %}

{% block extracss %}
<link href="{{ STATIC_URL }}ajaxuploader/css/fileuploader.css" media="screen" rel="stylesheet" type="text/css" />
{% endblock extracss %}

{% block crumbs %}
    {{ block.super }}
    <li>
        <span class="divider">/</span><a href="{% url 'list_open_firmbase_tickets' %}">Open FirmBase Tickets</a>
        <span class="divider">/</span>
        <a href="{% url 'edit_firmbase_ticket' object.pk %}">{{ transition.name }} {{ objectt }}</a>
    </li>
{% endblock crumbs %}

{% block title %}{{ transition.name }} {{ object }}{% endblock title %}

{% block content %}
    <div class="row-fluid">
        <div class="span12">
            <h2>{{ transition.name }} {{ object }}</h2>
        </div>
        <div class="span4">
            <h3>Current Ticket Details</h3>
            <table class="table table-condensed table-hover table-bordered">
                <tr><th>Form ID</th><td>{{ object.form_id }}</td></tr>
                <tr><th>Submit Time</th><td>{{ object.created_at }}</td></tr>
                <tr><th>Submitter</th><td>{{ object.submitter }}</td></tr>
                <tr><th>Creator</th><td>{{ object.created_by }}</td></tr>
                <tr><th>Last Edited By</th><td>{{ object.last_user }}</td></tr>
                <tr><th>Last Activity</th><td>{{ object.last_activity }}</td></tr>
                <tr><th>Assigned To</th><td>{{ object.assignee }}</td></tr>
                <tr><th>Description</th><td>{{ object.description|linebreaks }}</td></tr>
                <tr class="success"><th>Proposal Status</th><td>{{ object.proposal_status }}</td>
                {% if object.proposed_effort or object.proposed_hours %}
                    {% if object.proposed_effort %}
                    <tr class="success"><th>Proposal FFP</th><td>$ {{ object.proposed_effort }}</td>
                    {% elif object.proposed_hours %}
                    <tr class="success"><th>Proposal Hours</th><td>{{ object.proposed_hours }} hours</td>
                    {% endif %}
                <tr class="success"><th>Proposed Due Date</th><td>{{ object.proposed_due_date }}</td>
                <tr class="success"><th>Proposal Acceptance Due Date</th><td>{{ object.proposal_acceptance_due_date }}</td>
                <tr class="success"><th>Approval</th><td>{{ object.approver }} @ {{ object.approval_date }}</td></tr>
                <tr class="success"><th>Approval Note</th><td>{{ object.approval_comment }}</td></tr>
                {% endif %}
                <tr><th>Response</th><td>{{ object.response }}</td></tr>
            </table>
        </div>
        <div class="span4">
            <h3>Update Ticket</h3>
            <form id="transition-purchase-request" class="form-horizontal" action="" method="post" accept-charset="utf-8">
                {% csrf_token %}
                {{ form|as_bootstrap:"horizontal" }}
                <div class="form-actions">
                    <input class="btn {{ transition.button_type }}" type='submit' name='submit' value='{{ transition.name }}' />
                    <input class="btn btn-inverse" type='button' value='Cancel' onclick='history.go(-1)' />
                </div>
            </form>
        </div>
        {% url 'view_rfe' object.id as next_url %}
        <div class="span3">
            <h3>Notes</h3>
            {% if object.get_notes|length %}
            <ul>
                {% for note in object.get_notes %}
                <li><strong>{{ note.author }} @ {{ note.last_edited }}</strong><br/>{{ note.text|linebreaks }}</li>
                {% endfor %}
            </ul>
            {% else %}
            <em>There are currently no notes for this ticket.</em>
            {% endif %}
            <br/><small>You can add a new note use the field in the column to the left.</small>

            <h3>Attachments</h3>
            <div id="file-uploader" name="File" class="controls">
              <noscript>          
                <p>Please enable JavaScript to use file uploader.</p>
              </noscript>
              <p class="help-block">Drag and drop a file (PDF) of the memo here.</p>
            </div>
            {% for attachment in object.get_attachments %}
            <blockquote>
            <p><a href="{% url 'download_firmbase_ticket_attachment' attachment.file_id %}">{{ attachment.filename }}</a></p>
            <small>{{ attachment.uploader }} @ {{ attachment.upload_utc }}</small>
            </blockquote>
            {% endfor %}
        </div>
    </div>
{% endblock content %}

{% block extrajs %}
<script src="{{ STATIC_URL }}ajaxuploader/js/fileuploader.js" ></script>
<script>
    ATTACHMENTS = {};
    $(function(){
    var uploader = new qq.FileUploader({
        action: "{% url 'add_firmbase_ticket_attachment' object.id %}",
        element: $('#file-uploader')[0],
        multiple: true,
        onComplete: function(id, filename, responseJSON) {
            if(responseJSON.success) {
                ATTACHMENTS[id] = {'id': id,
                                   'filename': filename,
                                   'json': responseJSON};
                // hide the button since we only want 1 file uploaded
                $('.qq-upload-button').hide()
            } else {
                console.log('fail', id, filename, responseJSON);
            }
        },
        onAllComplete: function(uploads) {
            // uploads is an array of maps
            // the maps look like this: {file: FileObject, response: JSONServerResponse}
            // do nothing
        },
        params: {
            'csrf_token': '{{ csrf_token }}',
            'csrf_name': 'csrfmiddlewaretoken',
            'csrf_xname': 'X-CSRFToken',
        },
    });
    });
</script>
{% endblock extrajs %}
